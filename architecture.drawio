<mxfile host="app.diagrams.net" modified="2026-02-22T00:00:00.000Z" agent="Claude Code" version="24.0.0">
  <diagram id="paperalchemy-arch" name="PaperAlchemy-Architecture">
    <mxGraphModel dx="1422" dy="762" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- ================================================================ -->
        <!-- LAYER 1: USER INTERFACE                                          -->
        <!-- ================================================================ -->
        <mxCell id="C1" value="User Interface" style="swimlane;startSize=30;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=13;horizontal=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="20" width="1400" height="150" as="geometry" />
        </mxCell>

        <mxCell id="N1" value="&lt;b&gt;Gradio UI — localhost:7861&lt;/b&gt;&lt;br/&gt;Tab 1: Standard RAG (Streaming tokens via SSE)&lt;br/&gt;Tab 2: Agentic RAG (LangGraph — full reasoning)&lt;br/&gt;Tab 3: Infrastructure (one-click service links)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;spacingLeft=8;verticalAlign=middle;" vertex="1" parent="C1">
          <mxGeometry x="20" y="38" width="360" height="92" as="geometry" />
        </mxCell>

        <mxCell id="N2" value="&lt;b&gt;API Clients&lt;/b&gt;&lt;br/&gt;Swagger: localhost:8000/docs&lt;br/&gt;curl / httpx / Postman" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=center;verticalAlign=middle;" vertex="1" parent="C1">
          <mxGeometry x="410" y="38" width="220" height="92" as="geometry" />
        </mxCell>

        <!-- ================================================================ -->
        <!-- LAYER 2: FASTAPI APPLICATION                                     -->
        <!-- ================================================================ -->
        <mxCell id="C2" value="FastAPI Application — localhost:8000" style="swimlane;startSize=30;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="200" width="1400" height="100" as="geometry" />
        </mxCell>

        <mxCell id="F1" value="GET /health&lt;br/&gt;GET /api/v1/health" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C2">
          <mxGeometry x="10" y="28" width="155" height="54" as="geometry" />
        </mxCell>
        <mxCell id="F2" value="POST /api/v1/ask&lt;br/&gt;POST /api/v1/stream" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C2">
          <mxGeometry x="180" y="28" width="175" height="54" as="geometry" />
        </mxCell>
        <mxCell id="F3" value="POST /api/v1/ask-agentic" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C2">
          <mxGeometry x="370" y="28" width="205" height="54" as="geometry" />
        </mxCell>
        <mxCell id="F4" value="GET/POST /api/v1/search&lt;br/&gt;POST /api/v1/hybrid-search" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C2">
          <mxGeometry x="590" y="28" width="220" height="54" as="geometry" />
        </mxCell>
        <mxCell id="F5" value="POST /api/v1/ingest/fetch&lt;br/&gt;POST /api/v1/ingest/index&lt;br/&gt;POST /api/v1/ingest/reparse" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C2">
          <mxGeometry x="825" y="28" width="225" height="54" as="geometry" />
        </mxCell>

        <!-- ================================================================ -->
        <!-- LAYER 3a: STANDARD RAG PIPELINE                                 -->
        <!-- ================================================================ -->
        <mxCell id="C3" value="Standard RAG Pipeline" style="swimlane;startSize=30;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="20" y="330" width="430" height="300" as="geometry" />
        </mxCell>

        <mxCell id="SR1" value="&lt;b&gt;Redis Cache&lt;/b&gt;&lt;br/&gt;SHA256 key, TTL=24h&lt;br/&gt;~50ms on cache HIT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="10" y="38" width="195" height="68" as="geometry" />
        </mxCell>
        <mxCell id="SR2" value="&lt;b&gt;OpenSearch 2.19&lt;/b&gt;&lt;br/&gt;BM25 + KNN vector search&lt;br/&gt;RRF fusion pipeline&lt;br/&gt;arxiv-papers-chunks index" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="10" y="118" width="195" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SR3" value="&lt;b&gt;Jina AI Embeddings&lt;/b&gt;&lt;br/&gt;jina-embeddings-v3&lt;br/&gt;1024 dimensions&lt;br/&gt;retrieval.passage/query" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="220" y="38" width="195" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SR4" value="&lt;b&gt;Ollama LLM&lt;/b&gt;&lt;br/&gt;llama3.2:1b / 3b / 8b&lt;br/&gt;SSE token streaming&lt;br/&gt;RAG prompt template" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="220" y="130" width="195" height="68" as="geometry" />
        </mxCell>
        <mxCell id="SR5" value="&lt;b&gt;Langfuse v3 Tracing&lt;/b&gt; — per-stage spans: embed → search → prompt → generate" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3f51b5;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="10" y="215" width="405" height="40" as="geometry" />
        </mxCell>
        <mxCell id="SR6" value="&lt;b&gt;ResponseParser&lt;/b&gt; — JSON → regex → plain text fallback chain" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C3">
          <mxGeometry x="10" y="263" width="405" height="28" as="geometry" />
        </mxCell>

        <!-- ================================================================ -->
        <!-- LAYER 3b: AGENTIC RAG (LANGGRAPH)                               -->
        <!-- ================================================================ -->
        <mxCell id="C4" value="Agentic RAG — LangGraph StateGraph" style="swimlane;startSize=30;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="470" y="330" width="430" height="300" as="geometry" />
        </mxCell>

        <mxCell id="AG0" value="&lt;b&gt;Out-of-Scope Node&lt;/b&gt;&lt;br/&gt;score &lt; 40 → reject" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="10" y="38" width="135" height="52" as="geometry" />
        </mxCell>
        <mxCell id="AG1" value="&lt;b&gt;Guardrail Node&lt;/b&gt;&lt;br/&gt;Domain score 0-100&lt;br/&gt;≥ 40 → proceed" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="160" y="38" width="160" height="52" as="geometry" />
        </mxCell>
        <mxCell id="AG2" value="&lt;b&gt;Retrieve Node&lt;/b&gt;&lt;br/&gt;retrieve_papers tool call&lt;br/&gt;→ OpenSearch hybrid search" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="100" y="105" width="200" height="55" as="geometry" />
        </mxCell>
        <mxCell id="AG3" value="&lt;b&gt;Grade Documents Node&lt;/b&gt;&lt;br/&gt;Binary relevance per chunk&lt;br/&gt;structured LLM output" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="100" y="175" width="200" height="55" as="geometry" />
        </mxCell>
        <mxCell id="AG4" value="&lt;b&gt;Rewrite Query Node&lt;/b&gt;&lt;br/&gt;Adaptive refinement&lt;br/&gt;max 3 attempts" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="10" y="248" width="185" height="42" as="geometry" />
        </mxCell>
        <mxCell id="AG5" value="&lt;b&gt;Generate Answer Node&lt;/b&gt;&lt;br/&gt;RAG generation + citations&lt;br/&gt;reasoning step tracking" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C4">
          <mxGeometry x="215" y="248" width="205" height="42" as="geometry" />
        </mxCell>

        <!-- Internal Agentic edges -->
        <mxCell id="AE1" value="score≥40" edge="1" source="AG1" target="AG2" parent="C4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AE2" value="" edge="1" source="AG1" target="AG0" parent="C4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AE3" value="" edge="1" source="AG2" target="AG3" parent="C4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AE4" value="irrelevant" edge="1" source="AG3" target="AG4" parent="C4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AE5" value="relevant" edge="1" source="AG3" target="AG5" parent="C4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="AE6" value="retry" edge="1" source="AG4" target="AG2" parent="C4">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="50" y="265" />
              <mxPoint x="50" y="132" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ================================================================ -->
        <!-- LAYER 3c: DATA INGESTION PIPELINE                               -->
        <!-- ================================================================ -->
        <mxCell id="C5" value="Data Ingestion Pipeline" style="swimlane;startSize=30;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="920" y="330" width="500" height="300" as="geometry" />
        </mxCell>

        <mxCell id="DI1" value="&lt;b&gt;Airflow 2.10&lt;/b&gt;&lt;br/&gt;arxiv_paper_ingestion DAG&lt;br/&gt;HTTP-triggered or scheduled" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="170" y="38" width="185" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI2" value="&lt;b&gt;arXiv API&lt;/b&gt;&lt;br/&gt;3s rate limit&lt;br/&gt;cs.AI/LG/CL/CV/NE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="10" y="38" width="150" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI3" value="&lt;b&gt;MetadataFetcher&lt;/b&gt;&lt;br/&gt;Orchestrates fetch → parse → store&lt;br/&gt;Retry logic + deduplication" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="10" y="115" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI4" value="&lt;b&gt;Docling PDF Parser&lt;/b&gt;&lt;br/&gt;Section-aware extraction&lt;br/&gt;Max 50 pages / 50 MB" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="240" y="115" width="195" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI5" value="&lt;b&gt;/ingest/fetch + /ingest/index&lt;/b&gt;&lt;br/&gt;Airflow calls API via HTTP&lt;br/&gt;(avoids SQLAlchemy version conflict)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="10" y="190" width="215" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI6" value="&lt;b&gt;TextChunker + HybridIndexer&lt;/b&gt;&lt;br/&gt;600-word chunks, 100 overlap&lt;br/&gt;Section-aware → Jina embed → OpenSearch" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="240" y="190" width="250" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DI7" value="&lt;b&gt;PostgreSQL 17&lt;/b&gt; — paper metadata store (arxiv_id, title, authors, sections, status)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C5">
          <mxGeometry x="10" y="262" width="480" height="28" as="geometry" />
        </mxCell>

        <!-- Internal Ingestion edges -->
        <mxCell id="DIE1" value="" edge="1" source="DI1" target="DI3" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DIE2" value="" edge="1" source="DI2" target="DI3" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DIE3" value="" edge="1" source="DI3" target="DI4" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DIE4" value="" edge="1" source="DI4" target="DI6" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DIE5" value="" edge="1" source="DI5" target="DI3" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DIE6" value="" edge="1" source="DI3" target="DI7" parent="C5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ================================================================ -->
        <!-- LAYER 4: INFRASTRUCTURE                                          -->
        <!-- ================================================================ -->
        <mxCell id="C6" value="Infrastructure — Docker Compose (12 containers)" style="swimlane;startSize=30;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="660" width="1400" height="140" as="geometry" />
        </mxCell>

        <mxCell id="IN1" value="&lt;b&gt;PostgreSQL 17&lt;/b&gt;&lt;br/&gt;:5433 — paper metadata&lt;br/&gt;pgAdmin :5050" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="10" y="35" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN2" value="&lt;b&gt;OpenSearch 2.19&lt;/b&gt;&lt;br/&gt;:9201 — BM25 + KNN index&lt;br/&gt;Dashboards :5602" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="185" y="35" width="170" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN3" value="&lt;b&gt;Redis 7&lt;/b&gt;&lt;br/&gt;:6380 — query cache&lt;br/&gt;TTL: 24h configurable" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="370" y="35" width="155" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN4" value="&lt;b&gt;Ollama&lt;/b&gt;&lt;br/&gt;:11434 — local LLM&lt;br/&gt;llama3.2:1b / 3b / 8b" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="540" y="35" width="155" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN5" value="&lt;b&gt;Langfuse 3&lt;/b&gt;&lt;br/&gt;:3001 — RAG tracing&lt;br/&gt;ClickHouse + MinIO backend" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3f51b5;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="710" y="35" width="175" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN6" value="&lt;b&gt;Apache Airflow 2.10&lt;/b&gt;&lt;br/&gt;:8080 — ingestion scheduler&lt;br/&gt;HTTP-trigger + cron DAGs" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="900" y="35" width="185" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN7" value="&lt;b&gt;MinIO&lt;/b&gt;&lt;br/&gt;:9091 — object storage&lt;br/&gt;Langfuse media &amp; blobs" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="1100" y="35" width="155" height="80" as="geometry" />
        </mxCell>
        <mxCell id="IN8" value="&lt;b&gt;Jina AI&lt;/b&gt;&lt;br/&gt;api.jina.ai (external)&lt;br/&gt;jina-embeddings-v3" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="C6">
          <mxGeometry x="1270" y="35" width="120" height="80" as="geometry" />
        </mxCell>

        <!-- ================================================================ -->
        <!-- CROSS-LAYER EDGES                                                -->
        <!-- ================================================================ -->

        <!-- User → FastAPI -->
        <mxCell id="XE1" value="HTTP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="C1" target="C2" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FastAPI → Standard RAG (/ask, /stream) -->
        <mxCell id="XE2" value="/ask /stream" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="F2" target="C3" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FastAPI → Agentic RAG (/ask-agentic) -->
        <mxCell id="XE3" value="/ask-agentic" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="F3" target="C4" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- FastAPI → Ingestion -->
        <mxCell id="XE4" value="/ingest/*" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="F5" target="C5" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Processing → Infrastructure -->
        <mxCell id="XE5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="C3" target="C6" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XE6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="C4" target="C6" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XE7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;" edge="1" source="C5" target="C6" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>

  <!-- ====================================================================== -->
  <!-- PAGE 2: LANGGRAPH WORKFLOW DETAIL                                       -->
  <!-- ====================================================================== -->
  <diagram id="langgraph-detail" name="LangGraph-Workflow">
    <mxGraphModel dx="1422" dy="762" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="T1" value="LangGraph Agentic RAG — State Machine" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="200" y="20" width="580" height="40" as="geometry" />
        </mxCell>

        <!-- START -->
        <mxCell id="LG0" value="START" style="ellipse;whiteSpace=wrap;html=1;fillColor=#000000;fontColor=#ffffff;strokeColor=#000000;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="430" y="80" width="120" height="50" as="geometry" />
        </mxCell>

        <!-- Guardrail Node -->
        <mxCell id="LG1" value="&lt;b&gt;guardrail_node&lt;/b&gt;&lt;br/&gt;LLM scores query domain relevance (0-100)&lt;br/&gt;Threshold: ≥ 40 to proceed" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#c62828;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="160" width="320" height="70" as="geometry" />
        </mxCell>

        <!-- Out of Scope Node -->
        <mxCell id="LG2" value="&lt;b&gt;out_of_scope_node&lt;/b&gt;&lt;br/&gt;Returns polite domain rejection&lt;br/&gt;message without retrieval" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="720" y="160" width="280" height="70" as="geometry" />
        </mxCell>

        <!-- Retrieve Node -->
        <mxCell id="LG3" value="&lt;b&gt;retrieve_node&lt;/b&gt;&lt;br/&gt;LLM emits tool call for retrieve_papers()&lt;br/&gt;ToolNode executes → OpenSearch hybrid search" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="270" width="320" height="70" as="geometry" />
        </mxCell>

        <!-- Grade Documents Node -->
        <mxCell id="LG4" value="&lt;b&gt;grade_documents_node&lt;/b&gt;&lt;br/&gt;Scores each chunk: binary yes/no&lt;br/&gt;Structured LLM output (GradeDocuments)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="380" width="320" height="70" as="geometry" />
        </mxCell>

        <!-- Rewrite Query Node -->
        <mxCell id="LG5" value="&lt;b&gt;rewrite_query_node&lt;/b&gt;&lt;br/&gt;LLM reformulates query for better retrieval&lt;br/&gt;Increments retrieval_attempts counter" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="720" y="380" width="280" height="70" as="geometry" />
        </mxCell>

        <!-- Generate Answer Node -->
        <mxCell id="LG6" value="&lt;b&gt;generate_answer_node&lt;/b&gt;&lt;br/&gt;RAG generation with graded context&lt;br/&gt;Extracts citations + reasoning steps" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="490" width="320" height="70" as="geometry" />
        </mxCell>

        <!-- END -->
        <mxCell id="LG7" value="END" style="ellipse;whiteSpace=wrap;html=1;fillColor=#000000;fontColor=#ffffff;strokeColor=#000000;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="430" y="600" width="120" height="50" as="geometry" />
        </mxCell>

        <!-- Edges -->
        <mxCell id="LE1" value="" edge="1" source="LG0" target="LG1" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE2" value="score ≥ 40" edge="1" source="LG1" target="LG3" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE3" value="score &lt; 40" edge="1" source="LG1" target="LG2" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE4" value="" edge="1" source="LG2" target="LG7" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="860" y="650" />
              <mxPoint x="490" y="650" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="LE5" value="" edge="1" source="LG3" target="LG4" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE6" value="relevant" edge="1" source="LG4" target="LG6" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE7" value="irrelevant (attempts &lt; 3)" edge="1" source="LG4" target="LG5" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LE8" value="max attempts reached" edge="1" source="LG4" target="LG6" style="entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="230" y="415" />
              <mxPoint x="230" y="525" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="LE9" value="retry" edge="1" source="LG5" target="LG3" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1060" y="415" />
              <mxPoint x="1060" y="305" />
              <mxPoint x="650" y="305" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="LE10" value="" edge="1" source="LG6" target="LG7" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="LEG" value="&lt;b&gt;State:&lt;/b&gt; AgentState (TypedDict) — query, messages, retrieval_attempts, guardrail_score, rewritten_query, sources, reasoning_steps&lt;br/&gt;&lt;b&gt;Context:&lt;/b&gt; Runtime[Context] — OllamaClient, OpenSearchClient, GraphConfig injected at compile-time (no global state)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="50" y="600" width="720" height="60" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
